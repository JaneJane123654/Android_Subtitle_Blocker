# 字幕遮挡器框架设计与实现文档（贴近最终代码生成）
## 需求分析
来源： 项目描述文件.md 、 简单实现框架文件.md 。目标：Android 21+ 悬浮字幕遮挡（纯黑不透明+1px浅灰描边），支持拖动、缩放（右下 24dp 手柄）、边缘吸附（15dp）、关闭按钮（右上/左上可配、渐隐 300ms）、旋转自适应、可选音效、后台保活（Android 14 适配），并具备日志与≥80%核心单测。

## 设计说明
采用 MVVM + 分层接口，隔离系统能力，保证可测与可替换。

- ui ： OverlayWindowView （纯渲染+事件转发）、 OverlayViewBinder
- vm ： OverlayViewModel （状态机/约束/动画决策）
- domain ： OverlayInteractor （编排：权限→显示→持久化→保活）
- platform ： FloatWindowController （封装 FloatingX）、 PermissionNavigator 、 ScreenInfoProvider
- data ： SettingsRepository （SharedPreferences/DataStore 抽象）、 SoundPlayer
- infra ： Logger （统一打点）
## 方案细节
主流程：启动页/设置页 → PermissionNavigator.ensureOverlayPermission() 引导 → OverlayInteractor.show() → FloatWindowController.show(OverlayWindowView) ；交互事件（drag/resize/close）→ VM 产出新 OverlayState + AnimationSpec → View 仅做 apply(state, anim) ；结束时 SettingsRepository.save(stateSubset) 。
关键接口（建议直接生成同名文件与方法签名）：

- interface FloatWindowController { fun show(view); fun hide(); fun update(x,y,w,h, anim); fun isShowing():Boolean }
- interface SettingsRepository { fun load():Settings; fun save(settings) }
- class OverlayViewModel { fun onDrag(dx,dy); fun onResize(dw,dh); fun onCloseClick(); fun onRotationChanged(bounds) } 约束算法：VM 内统一 clampSize(min=100dp×40dp, max=0.8*screen) 、 clampPosition(with safeInsets) 、 snapToEdge(threshold=15dp) ；动画参数：移动 150ms、缩放 200ms、关闭渐隐 300ms。
## 数据结构
- OverlayState{ int widthPx,heightPx,xPx,yPx; boolean visible; ClosePos closePos; boolean soundEnabled }
- ScreenBounds{ int widthPx,heightPx; Insets safeInsets }
- Settings{ ClosePos closePos; boolean soundEnabled }
- AnimationSpec{ long durationMs; InterpolatorType type }
## 测试计划
- 单测：尺寸/位置边界、吸附判定、旋转重算、设置持久化读写、关闭状态机（可用假 ScreenInfoProvider/SettingsRepository ）。
- 集成：权限未开→引导→返回后显示；FloatingX show/hide/update 调用序列；前台服务启动/停止（Android 14 分支）。
## 验收标准
- API21+ 可用；Android14 权限/前台服务路径无崩溃。
- 遮挡纯黑 100% 不透明，描边可见；拖动/缩放/关闭动画时长符合要求。
- 任何时刻不越界，靠边 15dp 内自动吸附；交互延迟<100ms。
- 核心单测覆盖≥80%，关键路径日志可追踪。