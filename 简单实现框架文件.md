toolName: view_folder
            
status: success
          
d:\project\zimuzhedang
          

        
            
toolName: todo_write
            
status: success
          
Todos updated: 1 items
          

        
            
toolName: todo_write
            
status: success
          
Todos updated: 1 items
          
以下为基于 [项目描述文件.md] 的架构设计与实现文档（可直接指导落地），内容控制在约 200–500 字。

---

# 字幕遮挡器架构设计与实现方案

## 需求分析
目标是在 Android 5.0+（API 21）上实现可悬浮的字幕遮挡器，适配 Android 14 深度优化，满足尺寸/位置调节、边缘吸附、关闭按钮位置配置、权限引导、稳定后台保活和性能限制等要求。约束包含 FloatingX 2.3.7+、Java 8、MVP/MVVM、详细日志与测试覆盖率目标。

## 设计说明
采用 MVVM：UI 仅负责渲染与输入转发，业务逻辑集中在 ViewModel，系统能力封装为可替换的 Service/Repository。核心模块：  
1) FloatWindowManager：封装 FloatingX 生命周期、权限检查、显示/隐藏；  
2) OverlayView：遮挡器视图（黑色背景、描边、关闭按钮、调节手柄）；  
3) OverlayViewModel：状态机与交互规则（尺寸、位置、吸附、边界限制、动画参数）；  
4) SettingsRepository：持久化关闭按钮位置、音效开关等；  
5) Logger：统一日志接口；  
6) KeepAliveService：前台服务保活与系统策略差异化处理。

## 方案细节
流程：应用启动→权限引导→创建悬浮窗→用户拖动/缩放→状态更新→持久化。  
拖动与缩放统一走 GestureController，输入事件转为状态更新，ViewModel 计算约束（最小/最大/边界/吸附），下发给 OverlayView 渲染并触发动画。  
关闭按钮位置由设置驱动，点击触发渐隐并销毁悬浮窗。Android 14+ 走最新权限/前台服务要求，低版本兼容路径内置。

## 数据结构
- OverlayState：width、height、x、y、isVisible、closeButtonPosition、isSoundEnabled  
- ScreenBounds：width、height、safeInsets  
- AnimationSpec：durationMs、interpolator  
- Settings：closeButtonPosition、soundEnabled

## 测试计划
- 单测：尺寸约束、边界限制、吸附逻辑、位置换算、状态持久化  
- 集成：权限流程、悬浮窗显示/隐藏、旋转适配  
- 性能：拖动/缩放响应 <100ms，动画 60fps

## 验收标准
- 需求 1–10 全覆盖  
- 悬浮遮挡完全不透明黑色  
- 关闭/缩放/拖动均有动画与无越界  
- API 21+ 正常运行，Android 14 优化生效  
- 单测覆盖率 ≥80%，关键路径日志可追踪


